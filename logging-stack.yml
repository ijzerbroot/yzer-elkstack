version: '3.4'

# upload the configs
# label the worker nodes
# build kibana: localhost/kibana-logtrail:6.1.1


configs:
  elastconf:
    external: true
#  esrepo:
#    external: true
  fbyaml:
    external: true
  kbsetup:
    external: true
  kbyaml:
    external: true
  logtrailconfig:
    external: true

networks:
  infra:
    driver: overlay
  traefik:
    external:
      name: traefik

volumes:
    esdata:
      name: esdata

services:

  filebeater:
    image: docker.elastic.co/beats/filebeat:6.1.1
    deploy:
      mode: global
    configs:
      - source: fbyaml
        target: /etc/filebeat.yml
        mode: 0644
    command: -c /etc/filebeat.yml -e
    user: root
    volumes:
      - /var/log:/var/hostlog:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
     - infra
    depends_on:
     - elasticsearch


# no longer necessary with telegraf and kapacitor
#  metricbeater:
#    image: fedora:26
#    deploy:
#      mode: global
#    configs:
#      - source: esrepo
#        target: /etc/yum.repos.d/elastic.repo
#        mode: 0644
#      - source: mbyaml
#        target: /opt/metricbeat.yaml
#        mode: 0644
#      - source: mbsetup
#        target: /setup.sh
#        mode: 0755
#    entrypoint: /setup.sh
#    volumes:
#      - /proc:/hostfs/proc:ro
#      - /sys/fs/cgroup:/hostfs/sys/fs/cgroup:ro
#      - /:/hostfs:ro
#    networks:
#      - elk

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch-oss:6.1.1
    configs:
      - source: elastconf
        target: /usr/share/elasticsearch/config/elasticsearch.yml
        mode: 0644
    volumes:
      - esdata:/usr/share/elasticsearch/data
    environment:
      ES_JAVA_OPTS: "-Xmx512m -Xms256m"
    networks:
      - infra
    labels:
      org.label-schema.group: "monitoring"
    deploy:
      restart_policy:
        condition: on-failure
      placement:
        constraints:
          - node.labels.elasticsearch == true

#  logstash:
#    image: docker.elastic.co/logstash/logstash-oss:6.1.1
#    configs:
#      - source: lsconf
#        target: /usr/share/logstash/pipeline/logstash.conf
#        mode: 0644
#      - source: lsyaml
#        target: /usr/share/logstash/config/logstash.yml
#        mode: 0644
#      - source: lssetup
#        target: /setup.sh
#        mode: 0755
#    ports:
#      - "5000:5000"
#      - "5044:5044"
#    environment:
#      LS_JAVA_OPTS: "-Xmx256m -Xms256m"
#      xpack.security.enabled: "false"
#      LOGSPOUT: "ignore"
#    entrypoint: /setup.sh
#    depends_on:
#      - elasticsearch
#    networks:
#      - elk
#    labels:
#      org.label-schema.group: "monitoring"

  kibana:
#    image: docker.elastic.co/kibana/kibana-oss:6.1.1
    image: localhost/kibana-logtrail:6.1.1
    configs:
      - source: kbyaml
        target: /usr/share/kibana/config/kibana.yml
        mode: 0644
      - source: logtrailconfig
        target: /tmp/logtrailconf
        mode: 0644
      - source: kbsetup
        target: /setup.sh
        mode: 0755
#    ports:
#      - "5601"
    networks:
      - infra
      - traefik
    depends_on:
      - elasticsearch
#    entrypoint: /setup.sh
    labels:
       org.label-schema.group: "monitoring"
    deploy:
      labels:
         - "traefik.port=5601"
         - "traefik.docker.network=traefik"
         - "traefik.backend=kibana"
         - "traefik.backend.loadbalancer.method=wrr"
         - "traefik.enable=true"
         - "traefik.frontend.entryPoints=management"
         - "traefik.frontend.rule=Host:kibana.lift"
      replicas: 1
      placement:
        constraints:
          - node.labels.kibana == true
